<?php
 define('SERVICES_JSON_SLICE',1);define('SERVICES_JSON_IN_STR',2);define('SERVICES_JSON_IN_ARR',3);define('SERVICES_JSON_IN_OBJ',4);define('SERVICES_JSON_IN_CMT',5);define('SERVICES_JSON_LOOSE_TYPE',16);define('SERVICES_JSON_SUPPRESS_ERRORS',32);class Services_JSON{function Services_JSON($a=0){$this->use=$a;}function utf162utf8($b){if(function_exists('mb_convert_encoding')){return mb_convert_encoding($b,'UTF-8','UTF-16');}$d=(ord($b{0})<<8)|ord($b{1});switch(true){case ((0x7F&$d)==$d):return chr(0x7F&$d);case (0x07FF&$d)==$d:return chr(0xC0|(($d>>6)&0x1F)).chr(0x80|($d&0x3F));case (0xFFFF&$d)==$d:return chr(0xE0|(($d>>12)&0x0F)).chr(0x80|(($d>>6)&0x3F)).chr(0x80|($d&0x3F));}return'';}function utf82utf16($e){if(function_exists('mb_convert_encoding')){return mb_convert_encoding($e,'UTF-16','UTF-8');}switch(strlen($e)){case 1:return $e;case 2:return chr(0x07&(ord($e{0})>>2)).chr((0xC0&(ord($e{0})<<6))|(0x3F&ord($e{1})));case 3:return chr((0xF0&(ord($e{0})<<4))|(0x0F&(ord($e{1})>>2))).chr((0xC0&(ord($e{1})<<6))|(0x7F&ord($e{2})));}return'';}function encode($f){switch(gettype($f)){case  'boolean':return $f?'true':'false';case  'NULL':return 'null';case  'integer':return (int) $f;case  'double':case  'float':return (float) $f;case  'string':$g='';$h=strlen($f);for($j=0;$j<$h;++$j){$k=ord($f{$j});switch(true){case  $k==0x08:$g.='\b';break;case  $k==0x09:$g.='\t';break;case  $k==0x0A:$g.='\n';break;case  $k==0x0C:$g.='\f';break;case  $k==0x0D:$g.='\r';break;case  $k==0x22:case  $k==0x2F:case  $k==0x5C:$g.='\\'.$f{$j};break;case (($k>=0x20)&&($k<=0x7F)):$g.=$f{$j};break;case (($k&0xE0)==0xC0):$l=pack('C*',$k,ord($f{$j+1}));$j+=1;$b=$this->utf82utf16($l);$g.=sprintf('\u%04s',bin2hex($b));break;case (($k&0xF0)==0xE0):$l=pack('C*',$k,ord($f{$j+1}),ord($f{$j+2}));$j+=2;$b=$this->utf82utf16($l);$g.=sprintf('\u%04s',bin2hex($b));break;case (($k&0xF8)==0xF0):$l=pack('C*',$k,ord($f{$j+1}),ord($f{$j+2}),ord($f{$j+3}));$j+=3;$b=$this->utf82utf16($l);$g.=sprintf('\u%04s',bin2hex($b));break;case (($k&0xFC)==0xF8):$l=pack('C*',$k,ord($f{$j+1}),ord($f{$j+2}),ord($f{$j+3}),ord($f{$j+4}));$j+=4;$b=$this->utf82utf16($l);$g.=sprintf('\u%04s',bin2hex($b));break;case (($k&0xFE)==0xFC):$l=pack('C*',$k,ord($f{$j+1}),ord($f{$j+2}),ord($f{$j+3}),ord($f{$j+4}),ord($f{$j+5}));$j+=5;$b=$this->utf82utf16($l);$g.=sprintf('\u%04s',bin2hex($b));break;}}return'"'.$g.'"';case  'array':if(is_array($f)&&count($f)&&(array_keys($f)!==range(0,sizeof($f)-1))){$n=array_map(array($this,'name_value'),array_keys($f),array_values($f));foreach($n as $o){if(Services_JSON::isError($o)){return $o;}}return'{'.join(',',$n).'}';}$p=array_map(array($this,'encode'),$f);foreach($p as $q){if(Services_JSON::isError($q)){return $q;}}return'['.join(',',$p).']';case  'object':$r=get_object_vars($f);$n=array_map(array($this,'name_value'),array_keys($r),array_values($r));foreach($n as $o){if(Services_JSON::isError($o)){return $o;}}return'{'.join(',',$n).'}';default:return($this->use&SERVICES_JSON_SUPPRESS_ERRORS)?'null':new Services_JSON_Error(gettype($f)." can not be encoded as JSON string");}}function name_value($s,$t){$u=$this->encode($t);if(Services_JSON::isError($u)){return $u;}return $this->encode(strval($s)).':'.$u;}function reduce_string($v){$v=preg_replace(array('#^\s*//(.+)$#m','#^\s*/\*(.+)\*/#Us','#/\*(.+)\*/\s*$#Us'),'',$v);return trim($v);}function decode($v){$v=$this->reduce_string($v);switch(strtolower($v)){case  'true':return true;case  'false':return false;case  'null':return null;default:$w=array();if(is_numeric($v)){return((float)$v==(integer)$v)?(integer)$v:(float)$v;}elseif(preg_match('/^("|\').*(\1)$/s',$v,$w)&&$w[1]==$w[2]){$x=substr($v,0,1);$y=substr($v,1,-1);$e='';$z=strlen($y);for($j=0;$j<$z;++$j){$aa=substr($y,$j,2);$bb=ord($y{$j});switch(true){case  $aa=='\b':$e.=chr(0x08);++$j;break;case  $aa=='\t':$e.=chr(0x09);++$j;break;case  $aa=='\n':$e.=chr(0x0A);++$j;break;case  $aa=='\f':$e.=chr(0x0C);++$j;break;case  $aa=='\r':$e.=chr(0x0D);++$j;break;case  $aa=='\\"':case  $aa=='\\\'':case  $aa=='\\\\':case  $aa=='\\/':if(($x=='"'&&$aa!='\\\'')||($x=="'"&&$aa!='\\"')){$e.=$y{++$j};}break;case  preg_match('/\\\u[0-9A-F]{4}/i',substr($y,$j,6)):$b=chr(hexdec(substr($y,($j+2),2))).chr(hexdec(substr($y,($j+4),2)));$e.=$this->utf162utf8($b);$j+=5;break;case ($bb>=0x20)&&($bb<=0x7F):$e.=$y{$j};break;case ($bb&0xE0)==0xC0:$e.=substr($y,$j,2);++$j;break;case ($bb&0xF0)==0xE0:$e.=substr($y,$j,3);$j+=2;break;case ($bb&0xF8)==0xF0:$e.=substr($y,$j,4);$j+=3;break;case ($bb&0xFC)==0xF8:$e.=substr($y,$j,5);$j+=4;break;case ($bb&0xFE)==0xFC:$e.=substr($y,$j,6);$j+=5;break;}}return $e;}elseif(preg_match('/^\[.*\]$/s',$v)||preg_match('/^\{.*\}$/s',$v)){if($v{0}=='['){$cc=array(SERVICES_JSON_IN_ARR);$dd=array();}else{if($this->use&SERVICES_JSON_LOOSE_TYPE){$cc=array(SERVICES_JSON_IN_OBJ);$ee=array();}else{$cc=array(SERVICES_JSON_IN_OBJ);$ee=new stdClass();}}array_push($cc,array('what'=>SERVICES_JSON_SLICE,'where'=>0,'delim'=>false));$y=substr($v,1,-1);$y=$this->reduce_string($y);if($y==''){if(reset($cc)==SERVICES_JSON_IN_ARR){return $dd;}else{return $ee;}}$z=strlen($y);for($j=0;$j<=$z;++$j){$ff=end($cc);$aa=substr($y,$j,2);if(($j==$z)||(($y{$j}==',')&&($ff['what']==SERVICES_JSON_SLICE))){$gg=substr($y,$ff['where'],($j-$ff['where']));array_push($cc,array('what'=>SERVICES_JSON_SLICE,'where'=>($j+1),'delim'=>false));if(reset($cc)==SERVICES_JSON_IN_ARR){array_push($dd,$this->decode($gg));}elseif(reset($cc)==SERVICES_JSON_IN_OBJ){$hh=array();if(preg_match('/^\s*(["\'].*[^\\\]["\'])\s*:\s*(\S.*),?$/Uis',$gg,$hh)){$ii=$this->decode($hh[1]);$jj=$this->decode($hh[2]);if($this->use&SERVICES_JSON_LOOSE_TYPE){$ee[$ii]=$jj;}else{$ee->$ii=$jj;}}elseif(preg_match('/^\s*(\w+)\s*:\s*(\S.*),?$/Uis',$gg,$hh)){$ii=$hh[1];$jj=$this->decode($hh[2]);if($this->use&SERVICES_JSON_LOOSE_TYPE){$ee[$ii]=$jj;}else{$ee->$ii=$jj;}}}}elseif((($y{$j}=='"')||($y{$j}=="'"))&&($ff['what']!=SERVICES_JSON_IN_STR)){array_push($cc,array('what'=>SERVICES_JSON_IN_STR,'where'=>$j,'delim'=>$y{$j}));}elseif(($y{$j}==$ff['delim'])&&($ff['what']==SERVICES_JSON_IN_STR)&&((strlen(substr($y,0,$j))-strlen(rtrim(substr($y,0,$j),'\\')))%2!=1)){array_pop($cc);}elseif(($y{$j}=='[')&&in_array($ff['what'],array(SERVICES_JSON_SLICE,SERVICES_JSON_IN_ARR,SERVICES_JSON_IN_OBJ))){array_push($cc,array('what'=>SERVICES_JSON_IN_ARR,'where'=>$j,'delim'=>false));}elseif(($y{$j}==']')&&($ff['what']==SERVICES_JSON_IN_ARR)){array_pop($cc);}elseif(($y{$j}=='{')&&in_array($ff['what'],array(SERVICES_JSON_SLICE,SERVICES_JSON_IN_ARR,SERVICES_JSON_IN_OBJ))){array_push($cc,array('what'=>SERVICES_JSON_IN_OBJ,'where'=>$j,'delim'=>false));}elseif(($y{$j}=='}')&&($ff['what']==SERVICES_JSON_IN_OBJ)){array_pop($cc);}elseif(($aa=='/*')&&in_array($ff['what'],array(SERVICES_JSON_SLICE,SERVICES_JSON_IN_ARR,SERVICES_JSON_IN_OBJ))){array_push($cc,array('what'=>SERVICES_JSON_IN_CMT,'where'=>$j,'delim'=>false));$j++;}elseif(($aa=='*/')&&($ff['what']==SERVICES_JSON_IN_CMT)){array_pop($cc);$j++;for($kk=$ff['where'];$kk<=$j;++$kk)$y=substr_replace($y,' ',$kk,1);}}if(reset($cc)==SERVICES_JSON_IN_ARR){return $dd;}elseif(reset($cc)==SERVICES_JSON_IN_OBJ){return $ee;}}}}function isError($ll,$mm=null){if(class_exists('pear')){return PEAR::isError($ll,$mm);}elseif(is_object($ll)&&(get_class($ll)=='services_json_error'||is_subclass_of($ll,'services_json_error'))){return true;}return false;}}if(class_exists('PEAR_Error')){class Services_JSON_Error extends PEAR_Error{function Services_JSON_Error($nn='unknown error',$mm=null,$oo=null,$pp=null,$qq=null){parent::PEAR_Error($nn,$mm,$oo,$pp,$qq);}}}else{class Services_JSON_Error{function Services_JSON_Error($nn='unknown error',$mm=null,$oo=null,$pp=null,$qq=null){}}}?>